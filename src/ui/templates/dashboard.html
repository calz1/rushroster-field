<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RushRoster Field Device - {{ device_id }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            padding: 2rem;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 2rem;
            border-bottom: 2px solid #1e293b;
            padding-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: #1e293b;
            border-radius: 0.5rem;
            padding: 1.5rem;
            border: 1px solid #334155;
        }

        .card h2 {
            font-size: 1.25rem;
            color: #60a5fa;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            display: inline-block;
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-connected { background-color: #22c55e; }
        .status-disconnected { background-color: #ef4444; }
        .status-unknown { background-color: #eab308; }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #334155;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .card.compact .metric {
            padding: 0.25rem 0;
            border-bottom: none;
        }

        .metric-label {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .metric-value {
            color: #e2e8f0;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .card.compact .metric-value {
            font-size: 0.9rem;
            font-weight: 400;
        }

        .metric-value.large {
            font-size: 2rem;
            color: #60a5fa;
        }

        .metric-value.warning {
            color: #eab308;
        }

        .metric-value.danger {
            color: #ef4444;
        }

        .metric-value.success {
            color: #22c55e;
        }

        .metric-value.connected {
            color: #22c55e;
        }

        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background 0.2s;
            margin-top: 1rem;
            text-decoration: none;
            display: inline-block;
        }

        .button:hover {
            background: #2563eb;
        }

        .button-secondary {
            background: #475569;
            margin-right: 0.5rem;
        }

        .button-secondary:hover {
            background: #64748b;
        }

        .camera-feed {
            width: 100%;
            height: auto;
            border-radius: 0.375rem;
            background: #0f172a;
            border: 2px solid #334155;
        }

        .camera-container {
            width: 100%;
            aspect-ratio: 16/9;
            background: #0f172a;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .camera-offline {
            color: #64748b;
            font-size: 1rem;
        }

        .refresh-info {
            text-align: center;
            color: #64748b;
            font-size: 0.85rem;
            margin-top: 2rem;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>üöó RushRoster Field Device</h1>
                <div class="subtitle">Device ID: {{ device_id }} | {{ config.device.location.street_name }}</div>
            </div>
            <div>
                <a href="{{ cloud_config.api_url }}" class="button" target="_blank">üåê Main Site</a>
                <a href="/settings" class="button button-secondary">‚öôÔ∏è Settings</a>
                <a href="/events/browse" class="button">üìã View Events</a>
            </div>
        </header>

        <div class="grid">
            <!-- Device Status -->
            <div class="card compact">
                <h2>üì° Device Status</h2>
                <div class="metric">
                    <span class="metric-label">ñ¶è Radar Sensor</span>
                    <span class="metric-value {% if status.radar_status == 'Connected' %}success{% else %}danger{% endif %}">
                        {% if status.radar_status == 'Connected' %}‚úÖ{% else %}‚ùå{% endif %}
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">üì∏ Camera</span>
                    <span class="metric-value {% if status.camera_status == 'Connected' %}success{% else %}danger{% endif %}">
                        {% if status.camera_status == 'Connected' %}‚úÖ{% else %}‚ùå{% endif %}
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">‚áÑ Network</span>
                    <span class="metric-value {% if status.network_connected %}success{% else %}danger{% endif %}">
                        {% if status.network_connected %}‚úÖ{% else %}‚ùå{% endif %}
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Uptime</span>
                    <span class="metric-value">{{ "%.1f"|format(status.uptime_seconds / 3600) }} hrs</span>
                </div>
            </div>

            <!-- Live Sensor Readings -->
            <div class="card compact">
                <h2>üì∂ Live Sensor Readings</h2>
                <div class="metric">
                    <span class="metric-label">Current Speed</span>
                    <span class="metric-value large" id="current-speed" style="color: #60a5fa;">-- MPH</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Detection State</span>
                    <span class="metric-value" id="detection-state">idle</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Tracking</span>
                    <span class="metric-value" id="tracking-status">No</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Target Acquired</span>
                    <span class="metric-value" id="target-acquired">No</span>
                </div>
            </div>

            <!-- Live Camera Feed -->
            <div class="card" style="grid-column: span 2;">
                <h2>üìπ Live Camera Feed</h2>
                <div class="camera-container">
                    <img id="camera-feed" class="camera-feed" alt="Camera feed" style="display: none;">
                    <div id="camera-offline" class="camera-offline">Camera initializing...</div>
                </div>
            </div>

            <!-- Storage & Queue -->
            <div class="card compact">
                <h2>üíæ Storage & Queue</h2>
                <div class="metric">
                    <span class="metric-label">Disk Usage</span>
                    <span class="metric-value {% if status.disk_usage_percent > 90 %}danger{% elif status.disk_usage_percent > 75 %}warning{% endif %}">
                        {{ "%.1f"|format(status.disk_usage_percent) }}%
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Free Space</span>
                    <span class="metric-value">{{ "%.2f"|format(status.disk_free_gb) }} GB</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Upload Queue</span>
                    <span class="metric-value {% if status.upload_queue_size > 100 %}warning{% endif %}">
                        {{ status.upload_queue_size }} events
                    </span>
                </div>
                <button class="button" onclick="triggerUpload()">‚¨ÜÔ∏è Upload Now</button>
                <button class="button button-secondary" onclick="triggerDownload()">‚¨áÔ∏è Download</button>
                <button class="button button-secondary" onclick="forceResync()">üîÑ Force Resync</button>
            </div>

            <!-- Statistics (24h) -->
            <div class="card compact">
                <h2>üìä Statistics (24h)</h2>
                <div class="metric">
                    <span class="metric-label">Total Vehicles</span>
                    <span class="metric-value large">{{ stats.total_events }}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Speeders</span>
                    <span class="metric-value {% if stats.speeding_events > 0 %}warning{% endif %}">
                        {{ stats.speeding_events }}
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Average Speed</span>
                    <span class="metric-value">
                        {% if stats.avg_speed %}{{ "%.1f"|format(stats.avg_speed) }} MPH{% else %}N/A{% endif %}
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Max Speed</span>
                    <span class="metric-value danger">
                        {% if stats.max_speed %}{{ "%.1f"|format(stats.max_speed) }} MPH{% else %}N/A{% endif %}
                    </span>
                </div>
            </div>

            <!-- Configuration -->
            <div class="card compact">
                <h2>‚öôÔ∏è Configuration</h2>
                <div class="metric">
                    <span class="metric-label">Speed Limit</span>
                    <span class="metric-value">{{ config.device.speed_limit }} MPH</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Photo Trigger</span>
                    <span class="metric-value">+{{ config.thresholds.photo_trigger_over_limit }} MPH</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Upload Frequency</span>
                    <span class="metric-value">{{ config.upload.frequency_minutes }} min</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Location</span>
                    <span class="metric-value" style="font-size: 0.9rem;">
                        {{ "%.4f"|format(config.device.location.latitude) }}, {{ "%.4f"|format(config.device.location.longitude) }}
                    </span>
                </div>
            </div>
        </div>

        <div class="refresh-info">
            Live sensors via SSE stream (5x/sec) | Camera feed updates 2x/sec | Page refreshes every 30s | <span id="timestamp"></span>
        </div>
    </div>

    <script>
        // Update timestamp
        function updateTimestamp() {
            document.getElementById('timestamp').textContent = new Date().toLocaleTimeString();
        }
        updateTimestamp();

        // Update sensor display with data
        function updateSensorDisplay(data) {
            // Update current speed
            const speedElement = document.getElementById('current-speed');
            const speed = data.radar.current_speed;
            if (speed !== null && speed > 0) {
                speedElement.textContent = speed.toFixed(0) + ' MPH';
                // Color code based on speed
                if (speed > 35) {
                    speedElement.style.color = '#ef4444'; // red
                } else if (speed > 25) {
                    speedElement.style.color = '#eab308'; // yellow
                } else {
                    speedElement.style.color = '#22c55e'; // green
                }
            } else {
                speedElement.textContent = '-- MPH';
                speedElement.style.color = '#60a5fa'; // blue
            }

            // Update detection state
            const stateElement = document.getElementById('detection-state');
            stateElement.textContent = data.detection.state;
            stateElement.style.color = data.detection.state === 'tracking' ? '#22c55e' : '#94a3b8';

            // Update tracking status
            const trackingElement = document.getElementById('tracking-status');
            trackingElement.textContent = data.radar.tracking ? 'Yes' : 'No';
            trackingElement.style.color = data.radar.tracking ? '#22c55e' : '#94a3b8';

            // Update target acquired
            const targetElement = document.getElementById('target-acquired');
            targetElement.textContent = data.radar.target_acquired ? 'Yes' : 'No';
            targetElement.style.color = data.radar.target_acquired ? '#22c55e' : '#94a3b8';
        }

        // Connect to SSE stream for live sensor updates
        function connectSensorStream() {
            const eventSource = new EventSource('/sensors/stream');

            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    updateSensorDisplay(data);
                } catch (error) {
                    console.error('Error parsing sensor data:', error);
                }
            };

            eventSource.onerror = function(error) {
                console.error('SSE connection error:', error);
                eventSource.close();
                // Reconnect after 5 seconds
                setTimeout(connectSensorStream, 5000);
            };

            return eventSource;
        }

        // Update camera feed
        function updateCameraFeed() {
            const img = document.getElementById('camera-feed');
            const offlineMsg = document.getElementById('camera-offline');

            // Add timestamp to prevent caching
            const timestamp = new Date().getTime();
            const newSrc = `/camera/frame?hud=true&t=${timestamp}`;

            // Create a new image to test if camera is available
            const testImg = new Image();
            testImg.onload = function() {
                img.src = newSrc;
                img.style.display = 'block';
                offlineMsg.style.display = 'none';
            };
            testImg.onerror = function() {
                img.style.display = 'none';
                offlineMsg.style.display = 'block';
                offlineMsg.textContent = 'Camera offline';
            };
            testImg.src = newSrc;
        }

        // Connect to SSE stream for live sensor updates (more efficient than polling)
        connectSensorStream();

        // Update camera feed immediately and every 500ms (2 FPS)
        // Reduced from 5 FPS to avoid overloading Pi with object detection
        updateCameraFeed();
        setInterval(updateCameraFeed, 500);

        // Auto-refresh entire page every 30 seconds for stats
        setInterval(() => {
            location.reload();
        }, 30000);

        // Trigger manual upload
        async function triggerUpload() {
            try {
                const response = await fetch('/upload', { method: 'POST' });
                const data = await response.json();
                alert(data.message || 'Upload triggered');
            } catch (error) {
                alert('Error triggering upload: ' + error.message);
            }
        }

        // Trigger download from cloud
        async function triggerDownload() {
            if (!confirm('Download events from cloud? This will fetch all events from the remote server and add them to your local database.')) {
                return;
            }
            try {
                const response = await fetch('/download', { method: 'POST' });
                const data = await response.json();
                alert(data.message || 'Download initiated');
                // Reload page after a few seconds to show updated event count
                setTimeout(() => location.reload(), 3000);
            } catch (error) {
                alert('Error triggering download: ' + error.message);
            }
        }

        // Force resync - reset all events to not uploaded
        async function forceResync() {
            if (!confirm('Force Resync will mark ALL events as not uploaded, so they will be re-synced to the cloud (including photos). This is useful after photo upload errors. Continue?')) {
                return;
            }
            try {
                const response = await fetch('/force-resync', { method: 'POST' });
                const data = await response.json();
                alert(data.message || 'Force resync complete');
                // Reload page to show updated upload queue
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                alert('Error during force resync: ' + error.message);
            }
        }
    </script>
</body>
</html>
